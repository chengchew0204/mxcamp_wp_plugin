<!-- wp:html -->
<div class="calendar-post">

    <!-- /wp:html -->
    [add_eventon tiles="yes" jumper="yes" exp_jumper="yes" tile_count="5" tile_bg="1" lang='L2']
    <!--
    
    
    
    
    
    <p style="text-align: center;"><a style="text-decoration: none; color: #f5f5f5;" href="https://instagram.com/zipolitecamp" target="_blank" rel="noopener"><img style="width: 100%;" data-src="https://camp.mx/wp-content/uploads/2022/12/en-instag.png" alt="instagram" /></a></p>
    
    
    
    
    
    --></div>
    <!-- /wp:html -->
    
    
    
    <!-- wp:html -->
    <style>
        /* Event videos no longer use play/pause buttons - they are click-to-play */
    
     .evocard_row .fullscreen .timevideo {
        margin-top: 5px !important;
        position: absolute !important;
        bottom: 0 !important;
        top: unset !important;
        right: 0 !important;
        font-size: 15px !important;
        z-index: 10 !important;
        display: none;
    }
        .fullscreen .timevideo  {
            color: #F5f5f5 !important;
        }
        .videoplaying:hover .timevideo {
            display: block;
        }
        
    
    </style>
    <script>
    
    /*
     * CHANGES SUMMARY:
     * - Fixed blank gaps before video render with robust poster + CSS fallback approach
     * - Added Safari/iOS autoplay compatibility (muted + playsinline by default)
     * - Replaced brittle poster logic with reliable image detection
     * - Added error handling and spinner cleanup for failed video loads
     * - Maintained existing UX: spinner, custom controls, conditional native controls
     */
    
    function setOnClickOutside(ele, cb) {
        document.addEventListener('click', callback = (event) => {
            event.stopPropagation()
            let parent = document.getElementsByClassName("eventcard eventon_events_list show")[0]
                if (parent) {
                    let el = parent.getElementsByClassName(ele)[0]
                  //  console.log("el",el)
                    if (el && !el.contains(event.target)) {
                        cb();
                     // event.source.removeEventListener('click', callback);
                     }
                }
    
        });
    };
    
    /**
     * Sets up normal event behavior for video events - show featured image, hide video until ready
     * @param {HTMLVideoElement} videoEl - The video element
     * @param {HTMLElement} headerEl - The header container element
     * @param {HTMLElement} containerEl - The fullscreen container element
     */
    function setupNormalEventBehavior(videoEl, headerEl, containerEl) {
        // Find the original header image
        const headerImg = headerEl.querySelector('img');
        if (!headerImg) {
            console.log('No header image found, video will show immediately');
            return;
        }
        
        // Keep the original header image visible (like normal events)
        headerImg.style.display = 'block';
        console.log('Keeping featured image visible like normal events');
        
        // Hide the video initially
        videoEl.style.display = 'none';
        console.log('Video hidden initially - will show when ready');
        
        // Set video poster for when it becomes visible
        const posterUrl = headerImg.currentSrc || headerImg.src;
        if (posterUrl && !videoEl.poster) {
            videoEl.poster = posterUrl;
        }
        
        // Create and show loading spinner above the feature image
        const loadingSpinner = document.createElement('div');
        loadingSpinner.className = 'video-loading-spinner-overlay';
        loadingSpinner.innerHTML = `
            <div class="video-loading-spinner">
                <div class="spinner"></div>
            </div>
        `;
        
        // Position spinner in the header container (will be over the feature image)
        // The containerEl (fullscreen div) will be appended to headerEl later
        headerEl.style.position = 'relative';
        headerEl.appendChild(loadingSpinner);
        console.log('Loading spinner added to header container above feature image');
        
        // Show video and hide image + spinner when video is ready to play
        const showVideo = () => {
            headerImg.style.display = 'none';
            videoEl.style.display = 'block';
            // Hide the loading spinner
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
                console.log('Loading spinner hidden');
            }
            // Unmute video immediately when it becomes visible and starts playing
            videoEl.muted = false;
            console.log('Video ready - hiding featured image and spinner, showing video with audio');
        };
        
        // Listen for video ready events
        const events = ['loadeddata', 'canplay', 'playing'];
        const cleanup = () => {
            events.forEach(event => videoEl.removeEventListener(event, handleReady));
        };
        
        const handleReady = () => {
            showVideo();
            cleanup();
        };
        
        events.forEach(event => videoEl.addEventListener(event, handleReady, { once: true }));
        
        // On error, hide spinner and keep the featured image visible (like normal events)
        videoEl.addEventListener('error', () => {
            headerImg.style.display = 'block';
            videoEl.style.display = 'none';
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
                console.log('Video error - hiding loading spinner, keeping featured image visible');
            }
            cleanup();
            console.log('Video error - keeping featured image visible like normal event');
        }, { once: true });
        
        videoEl.addEventListener('stalled', () => {
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
                console.log('Video stalled - hiding loading spinner');
            }
            cleanup();
        }, { once: true });
    }
    
    setOnClickOutside(
        'evolb_content evo_lightbox_body eventon_list_event',
        () => {
            let active_card = document.getElementsByClassName('eventcard eventon_events_list show')[0];
            if (active_card) {
                let closeButton = active_card.getElementsByClassName('evolb_close_btn')[0]
                console.log("ActiveCardCloseButton", closeButton)
                closeButton.click()
            }
        }
    );

    // Add ESC key functionality to close calendar event cards
    function closeEventCardWithEsc() {
        let active_card = document.getElementsByClassName('eventcard eventon_events_list show')[0];
        if (active_card) {
            let closeButton = active_card.getElementsByClassName('evolb_close_btn')[0];
            if (closeButton) {
                console.log("Closing event card with ESC key");
                closeButton.click();
                return true; // Indicate that we handled the ESC key
            }
        }
        return false; // No active event card found
    }

    // Listen for ESC key presses
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            // Try to close calendar event card first
            if (closeEventCardWithEsc()) {
                event.preventDefault();
                event.stopPropagation();
            }
        }
    });
    
    function goToJan() {
        let janEl = document.querySelector(`.legend.evo_jumper_months a`)
        janEl.click()
    }
    
    const yearEls = document.querySelectorAll(".evo_j_years .legend a")
    yearEls.forEach((yearEl) => yearEl.addEventListener("click", () => setTimeout(goToJan,500)))
    
    
    
    
    function replaceByVideo(){
        let checkIfCalendarExist = setInterval(lookForIt, 100);
        
    
        function lookForIt(){
            let eventLightBox = document.getElementById('evo_lightboxes');
            
            if(eventLightBox){
                //Interval pour chercher l'élément
                clearInterval(checkIfCalendarExist);
                replaceNow();
            }else{
                console.log('searching evo_lightboxes');
            }
        }
    
    
        
        function replaceNow(){
            function searchAndReplace(){
        gtag('event', 'click', {
            'event_category': 'Event Card',
            'event_label': 'Event Card opened',
            'value': 1
          });
    
    
                let eventLightBox = document.getElementById('evo_lightboxes');
                let thisvideo = eventLightBox.querySelector('.eventon_full_description video.video-events-grid');
                if(thisvideo && thisvideo!=''){
    
                    // Old spinner removed - using new spinner system in setupNormalEventBehavior
                    
                    thisvideo.removeAttribute("controls");
    
                    // Safari/iOS autoplay compatibility setup
                    thisvideo.setAttribute('playsinline', '');
                    thisvideo.preload = thisvideo.preload || 'metadata';
                    thisvideo.muted = true; // Required for autoplay on Safari/iOS
                    thisvideo.volume = 0.5; // Will be applied when unmuted
    
                    let fullScreenDiv = document.createElement('div');
                    fullScreenDiv.classList.add('fullscreen', 'videoplaying');
    
                    // Find header container for normal event behavior setup
                    let thisHeader = eventLightBox.querySelector('.evocard_box.ftimage > div');
                    fullScreenDiv.appendChild(thisvideo);
                    
                    // Setup normal event behavior - show featured image, hide video until ready
                    // This function now handles the spinner creation and positioning
                    setupNormalEventBehavior(thisvideo, thisHeader, fullScreenDiv);
                    
                    // Attempt autoplay (will be muted on Safari/iOS)
                    setTimeout(() => {
                        thisvideo.play().catch(error => {
                            console.log('Autoplay failed (expected on some browsers):', error.message);
                        });
                    }, 1000);
                    
                    // Additional autoplay attempt for long videos after controls are added
                    setTimeout(() => {
                        if (thisvideo.paused && thisvideo.duration > 120) {
                            console.log('Attempting autoplay for long video in calendar');
                            thisvideo.play().catch(error => {
                                console.log('Long video autoplay retry failed:', error.message);
                            });
                        }
                    }, 2000);
                    
                    var controlsVisible = false;
                    thisvideo.addEventListener('timeupdate', function () {
                        if (thisvideo.currentTime >= 0.5 && !controlsVisible) {
                            controlsVisible = true;
                          }
                    });
                    thisHeader.appendChild(fullScreenDiv);
                    
                    // Play/pause buttons removed for event videos - videos are click-to-play without buttons
                   
                function playVideo() {
                let divplaying = document.querySelectorAll('.videoplaying');
                        // Stop other playing videos
                        divplaying.forEach(div => {
                            div.classList.remove('videoplaying');
                        });
                        
                        // Unmute on user gesture (enables audio on Safari/iOS)
                        thisvideo.muted = false;
                        thisvideo.play().catch(error => {
                            console.log('Play failed:', error.message);
                        });
                        thisvideo.closest(".fullscreen").classList.add('videoplaying');
            }
    
                function pauseVideo(){
                        thisvideo.pause();
                        let divplaying = document.querySelectorAll('.videoplaying');
                        // Parcourir chaque vidéo pour vérifier si elle est en cours de lecture
                        divplaying.forEach(div => {
                            div.classList.remove('videoplaying');
                        });
                    }
                   
                // Play/pause button event listeners removed - videos are now click-to-play without buttons
        
               // Crée l'affichage du temps
                const timeDisplay = document.createElement('p');
                timeDisplay.classList.add('timevideo');
    
                fullScreenDiv.appendChild(timeDisplay);
                // Play/pause buttons removed - videos are click-to-play without buttons
                
                // Add click-to-pause/play functionality to the video element
                thisvideo.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // Don't interfere if native controls are visible (long videos)
                    if (thisvideo.controls && thisvideo.duration > 120) {
                        console.log('Native controls active, letting default video click behavior handle it');
                        return;
                    }
                    
                    if (thisvideo.paused) {
                        console.log('Video clicked - playing');
                        playVideo();
                    } else {
                        console.log('Video clicked - pausing');
                        pauseVideo();
                    }
                });
                
                // Also make the fullscreen container clickable (but not the time display)
                fullScreenDiv.addEventListener('click', function(event) {
                    // Don't trigger if clicking on time display
                    if (event.target === timeDisplay) {
                        return;
                    }
                    
                    // Don't interfere if native controls are visible (long videos)
                    if (thisvideo.controls && thisvideo.duration > 120) {
                        return;
                    }
                    
                    event.preventDefault();
                    event.stopPropagation();
                    
                    if (thisvideo.paused) {
                        console.log('Video container clicked - playing');
                        playVideo();
                    } else {
                        console.log('Video container clicked - pausing');
                        pauseVideo();
                    }
                });
    
                // Affiche la durée totale lorsque les métadonnées de la vidéo sont chargées
                thisvideo.addEventListener('loadedmetadata', function() {
                    const durationMinutes = Math.floor(thisvideo.duration / 60);
                    const durationSeconds = Math.floor(thisvideo.duration % 60);

                    timeDisplay.textContent = `${durationMinutes}:${durationSeconds.toString().padStart(2, '0')}`;
                   console.log("Video duration:"+thisvideo.duration);
                   //add video controls for large videos
                            if(thisvideo.duration>120) // min duration to activate controls
                             {
                               thisvideo.controls = "controls";
                               controlsVisible=true;
                               //hide our time display for long videos with native controls
                               document.querySelector('.timevideo').style.display='none';
                               console.log("Activating Video controls for long video");
                               
                               // Ensure long videos still autoplay even with native controls
                               setTimeout(() => {
                                   if (thisvideo.paused) {
                                       thisvideo.play().catch(error => {
                                           console.log('Long video autoplay failed:', error.message);
                                       });
                                   }
                               }, 100);
                             }
                });
    
                // Ajoute un écouteur d'événement pour mettre à jour la barre de progression et le temps restant
                thisvideo.addEventListener('timeupdate', function () {
                    // Calcul du pourcentage de progression en fonction du temps écoulé
                    const elapsedTime = thisvideo.currentTime; // Temps écoulé
                    const totalTime = thisvideo.duration; // Durée totale
    
    
                    // Calcule le temps restant
                    const remainingTime = totalTime - elapsedTime;
                    const remainingMinutes = Math.floor(remainingTime / 60);
                    const remainingSeconds = Math.floor(remainingTime % 60);
    
                    // Affiche le temps restant
                    timeDisplay.textContent = `${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                });     
                }else{
                 //   console.log('pas delement video trouve');
                }
    
            }
            let targetNode = document.getElementById('evo_lightboxes');
            //element trouver, on lui attribut un event
            const config = { attributes: true, childList: true, subtree: true };
    
            // Callback function to execute when mutations are observed
            const callback = (mutationList, observer) => {
              for (const mutation of mutationList) {
                if (mutation.type === "childList") {
                  searchAndReplace();
                } else if (mutation.type === "attributes") {
                 // console.log(`The ${mutation.attributeName} attribute was modified.`);
                }
              }
            };
            
            // Create an observer instance linked to the callback function
            const observer = new MutationObserver(callback);
    
            
            // Start observing the target node for configured mutations
            try {
                observer.observe(targetNode, config);
            } catch (e) {
                console.log("Observer can't OBSERVE:", e)
            }
            
            // Later, you can stop observing
    //        observer.disconnect();
    
            
        }
    }
    replaceByVideo();
    
    function removeMonthTitles() {
        const monthElements = document.querySelectorAll(".evo_jumper_months a")
        monthElements.forEach((el) => el.removeAttribute("title"))
    }
    removeMonthTitles()
    
    // Simple and direct arrow key navigation for calendar months
    console.log('Setting up simple arrow key navigation...');
    
    function handleCalendarArrowKeys(event) {
        console.log('KEY PRESSED:', event.key, 'Code:', event.code);
        
        // Only handle left/right arrows
        if (event.key !== 'ArrowLeft' && event.key !== 'ArrowRight') {
            return;
        }
        
        // Don't interfere with typing
        if (event.target.tagName === 'INPUT' || 
            event.target.tagName === 'TEXTAREA' || 
            event.target.isContentEditable) {
            console.log('User is typing, ignoring arrow key');
            return;
        }
        
        // Don't interfere with open event cards
        const lightboxOpen = document.querySelector('#evo_lightboxes .eventcard.show');
        if (lightboxOpen) {
            console.log('Event card is open, ignoring arrow key');
            return;
        }
        
        console.log('ARROW KEY DETECTED:', event.key);
        
        // Find the compact calendar navigation
        const compactNav = document.querySelector('.compact-calendar-nav');
        if (!compactNav) {
            console.log('No compact calendar navigation found');
            return;
        }
        
        console.log('Found compact navigation:', compactNav);
        
        // Find all navigation divs
        const navDivs = compactNav.querySelectorAll('div.onmouseover-detail');
        console.log('Found navigation divs:', navDivs.length);
        
        if (navDivs.length < 4) {
            console.log('Not enough navigation divs found');
            return;
        }
        
        // Select the correct navigation button
        // Structure: [year-prev, year-next, month-prev, month-next]
        let targetButton = null;
        if (event.key === 'ArrowLeft') {
            targetButton = navDivs[2]; // Month previous
            console.log('LEFT ARROW: Selecting month previous button');
        } else {
            targetButton = navDivs[3]; // Month next  
            console.log('RIGHT ARROW: Selecting month next button');
        }
        
        if (!targetButton) {
            console.log('No target button found');
            return;
        }
        
        console.log('Target button found:', targetButton);
        console.log('Target button style:', targetButton.style.cssText);
        console.log('Target button visibility:', targetButton.style.visibility);
        console.log('Target button pointer events:', targetButton.style.pointerEvents);
        
        // Check if button is visible and clickable
        const isHidden = targetButton.style.visibility === 'hidden' || 
                        targetButton.style.pointerEvents === 'none';
        
        if (isHidden) {
            console.log('Target button is hidden/disabled, cannot navigate');
            event.preventDefault(); // Still prevent scrolling
            return;
        }
        
        console.log('CLICKING TARGET BUTTON...');
        
        // Try to click the button
        try {
            if (targetButton.onclick) {
                console.log('Calling onclick handler directly...');
                targetButton.onclick();
            } else {
                console.log('No onclick handler, trying click event...');
                targetButton.click();
            }
            
            console.log('BUTTON CLICKED SUCCESSFULLY');
            event.preventDefault();
            event.stopPropagation();
            
        } catch (error) {
            console.error('Error clicking button:', error);
        }
    }
    
    // Add multiple event listeners to ensure it works
    console.log('Adding arrow key event listeners...');
    
    // Method 1: Standard event listener
    document.addEventListener('keydown', handleCalendarArrowKeys);
    
    // Method 2: Capture phase
    document.addEventListener('keydown', handleCalendarArrowKeys, true);
    
    // Method 3: Window level
    window.addEventListener('keydown', handleCalendarArrowKeys);
    
    // Method 4: Direct assignment (will override any existing)
    const originalKeyHandler = document.onkeydown;
    document.onkeydown = function(event) {
        handleCalendarArrowKeys(event);
        // Call original handler if it exists
        if (originalKeyHandler) {
            originalKeyHandler(event);
        }
    };
    
    console.log('Arrow key navigation setup complete - 4 methods added');
    
    </script>
    <style>
    .ajde_evcal_calendar.boxy .eventon_list_event.event {
        aspect-ratio:3/4 !important;
        width:auto!important;
        min-height:unset !important;
        background-repeat: no-repeat;
    }
    .evo_metarow_directimg.evcal_evdata_row {
        padding: 0!important;
        height: auto;
    }
    .desc_trig_outter{
        background-repeat: no-repeat;
        background-size: cover !important;
        background-position-x: center;
    }
    .evcal_evdata_img, .ftimage {
        aspect-ratio:auto !important;
    }
    div.fullscreen {
        aspect-ratio:auto !important;
        height: 100%;
    }
    .fullscreen video {
        height: auto !important;
        left: 0;
        object-fit: cover;
        top: 0;
        position: relative;
        transform: none;
        transition: none;
        width: 100%;
        z-index: 0;
    }
    /* Hide repeating event tags */
    .evoet_tags.evo_above_title .evo_event_headers.repeating,
    .evo_event_headers.repeating {
        display: none !important;
    }
    
    /* Make videos clearly clickable for play/pause in calendar */
    .fullscreen video {
        cursor: pointer;
    }
    
    .fullscreen {
        cursor: pointer;
    }
    
    /* Don't show pointer cursor when native controls are active */
    .fullscreen video[controls] {
        cursor: default;
    }
    </style>
    <div class="tap-bottom" style="height:400px;width:120%; margin-left:-10%; margin-right:-10%; position:relative"></div>
    <!-- /wp:html -->
    